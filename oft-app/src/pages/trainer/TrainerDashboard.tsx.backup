/**
 * –î–∞—à–±–æ—Ä–¥ —Ç—Ä–µ–Ω–µ—Ä–∞ - –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞–º–∏
 */

import { useMemo, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { motion } from 'framer-motion';
import { useAppStore } from '../../store/useAppStore';
import { useAuthStore } from '../../store/useAuthStore';
import Button from '../../components/ui/Button';
import TelegramIcon from '../../components/ui/TelegramIcon';
import type { Client } from '../../data/models/types';
import { ClientGoal, Equipment } from '../../data/models/types';
import { ROUTES } from '../../router/routes';
import { fetchChatIdByUsername, saveClient } from '../../lib/supabaseProfiles';
import { sendTelegramMessage } from '../../config/telegram';

export default function TrainerDashboard() {
  const navigate = useNavigate();
  const allClients = useAppStore((state) => state.clients || []);
  const addClient = useAppStore((state) => state.addClient);
  const addToast = useAppStore((state) => state.addToast);
  const currentUser = useAuthStore((state) => state.user);
  
  // –§–∏–ª—å—Ç—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ —Ç—Ä–µ–Ω–µ—Ä—É
  const clients = allClients.filter(client => client.assignedTrainerId === currentUser?.id);
  
  const [showAIAnalysis, setShowAIAnalysis] = useState(false);
  const [showTelegramAdd, setShowTelegramAdd] = useState(false);
  const [telegramUsername, setTelegramUsername] = useState('');
  
  // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç—Ä–µ–Ω–µ—Ä–∞
  const stats = useMemo(() => {
    const totalClients = clients.length;
    
    // –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π (–∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤)
    const weekAgo = new Date();
    weekAgo.setDate(weekAgo.getDate() - 7);
    
    const workoutsLastWeek = clients.reduce((sum, client) => {
      const history = client.workoutHistory || client.completedWorkouts || [];
      const recentWorkouts = history.filter((w) => {
        const workoutDate = new Date(w.date);
        return workoutDate >= weekAgo;
      });
      return sum + recentWorkouts.length;
    }, 0);
    
    // –ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏ (–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ / –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ)
    // –°—á–∏—Ç–∞–µ–º –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –Ω–∞ –Ω–µ–¥–µ–ª—é
    const totalAssignedWorkouts = clients.reduce((sum, client) => {
      const weeklyPlan = client.weeklyPlan || {};
      const daysWithPlan = Object.values(weeklyPlan).filter(day => day && day.length > 0).length;
      return sum + daysWithPlan;
    }, 0);
    
    const completionRate = totalAssignedWorkouts > 0
      ? Math.round((workoutsLastWeek / totalAssignedWorkouts) * 100)
      : 0;
    
    return {
      totalClients,
      workoutsLastWeek,
      completionRate,
    };
  }, [clients]);

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞
  const getClientStatus = (client: Client): { label: string; color: string; bg: string } => {
    const completedWorkouts = client.completedWorkouts || [];
    const weeklyPlan = client.weeklyPlan || {};
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–ª–∞–Ω –Ω–∞ —Ç–µ–∫—É—â—É—é –Ω–µ–¥–µ–ª—é
    const hasCurrentWeekPlan = Object.values(weeklyPlan).some(day => day && day.length > 0);
    
    if (!hasCurrentWeekPlan) {
      return {
        label: '–ù—É–∂–Ω–æ –≤–Ω–∏–º–∞–Ω–∏–µ',
        color: '#ef4444',
        bg: 'rgba(239, 68, 68, 0.2)',
      };
    }
    
    if (completedWorkouts.length === 0) {
      return {
        label: '–ù—É–∂–Ω–æ –≤–Ω–∏–º–∞–Ω–∏–µ',
        color: '#ef4444',
        bg: 'rgba(239, 68, 68, 0.2)',
      };
    }
    
    // –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
    const lastWorkout = completedWorkouts
      .map(w => ({ date: new Date(w.date), workout: w }))
      .sort((a, b) => b.date.getTime() - a.date.getTime())[0];
    
    if (!lastWorkout) {
      return {
        label: '–ù—É–∂–Ω–æ –≤–Ω–∏–º–∞–Ω–∏–µ',
        color: '#ef4444',
        bg: 'rgba(239, 68, 68, 0.2)',
      };
    }
    
    const daysSinceLastWorkout = Math.floor(
      (new Date().getTime() - lastWorkout.date.getTime()) / (1000 * 60 * 60 * 24)
    );
    
    if (daysSinceLastWorkout <= 3) {
      return {
        label: '–ê–∫—Ç–∏–≤–µ–Ω',
        color: '#4ade80',
        bg: 'rgba(74, 222, 128, 0.2)',
      };
    } else if (daysSinceLastWorkout <= 5) {
      return {
        label: '–ó–∞—Å—ã–ø–∞–µ—Ç',
        color: '#eab308',
        bg: 'rgba(234, 179, 8, 0.2)',
      };
    } else {
      return {
        label: '–ù—É–∂–Ω–æ –≤–Ω–∏–º–∞–Ω–∏–µ',
        color: '#ef4444',
        bg: 'rgba(239, 68, 68, 0.2)',
      };
    }
  };

  const handleAddClient = () => {
    navigate(ROUTES.TRAINER.ADD_CLIENT);
  };

  const handleTelegramAdd = async () => {
    if (!telegramUsername.trim()) {
      addToast({ type: 'error', message: '–í–≤–µ–¥–∏—Ç–µ username' });
      return;
    }

    const username = telegramUsername.trim().replace('@', '');
    
    // –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
    const tempClientId = `temp-${Date.now()}`;
    const tempClient: Client = {
      id: tempClientId,
      name: `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${username}`,
      age: 25,
      goal: ClientGoal.MuscleGain,
      equipment: Equipment.Gym,
      telegramUsername: username,
      assignedTrainerId: currentUser?.id,
      isFirstLogin: true,
    };

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º store
    addClient(tempClient);

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
    const chatId = await fetchChatIdByUsername(username);
    if (chatId) {
      const message = `–ü—Ä–∏–≤–µ—Ç! –¢—Ä–µ–Ω–µ—Ä –ø—Ä–∏–≥–ª–∞—à–∞–µ—Ç –≤–∞—Å –≤ —Ñ–∏—Ç–Ω–µ—Å-—Å–µ—Ä–≤–∏—Å OFT.\n\n–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É—á–∞—Å—Ç–∏–µ:`;
      const replyMarkup = {
        inline_keyboard: [
          [
            { text: '‚úÖ –ü—Ä–∏–Ω—è—Ç—å', callback_data: `accept_${tempClientId}` },
            { text: '‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å', callback_data: `decline_${tempClientId}` }
          ]
        ]
      };
      const sendResult = await sendTelegramMessage(chatId, message, { reply_markup: replyMarkup });
      if (sendResult.ok) {
        addToast({ type: 'success', message: '–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!' });
      } else {
        addToast({ type: 'error', message: '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è' });
      }
    } else {
      addToast({ type: 'warning', message: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–æ—Ç–µ. –ü–æ–ø—Ä–æ—Å–∏—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å /start' });
    }

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å Supabase
    saveClient(tempClient);

    setShowTelegramAdd(false);
    setTelegramUsername('');
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ü–µ–ª–∏ –∫–ª–∏–µ–Ω—Ç–∞
  const getGoalLabel = (goal: ClientGoal): string => {
    const labels: Record<ClientGoal, string> = {
      [ClientGoal.WeightLoss]: '–ü–æ—Ö—É–¥–µ–Ω–∏–µ',
      [ClientGoal.MuscleGain]: '–ù–∞–±–æ—Ä –º–∞—Å—Å—ã',
      [ClientGoal.Endurance]: '–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å',
      [ClientGoal.Strength]: '–°–∏–ª–∞',
    };
    return labels[goal] ?? goal;
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
  const getEquipmentLabel = (equipment: Equipment): string => {
    const labels = {
      [Equipment.Gym]: '–¢—Ä–µ–Ω–∞–∂–µ—Ä–Ω—ã–π –∑–∞–ª',
      [Equipment.Home]: '–î–æ–º–∞',
    };
    return labels[equipment] || equipment;
  };

  // –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  if (clients.length === 0) {
    return (
      <div className="min-h-screen flex items-center justify-center p-6 animate-fade-in">
        <div className="card max-w-md text-center w-full">
          <div className="text-7xl mb-6 animate-float">üèãÔ∏è‚Äç‚ôÇÔ∏è</div>
          <h2 className="text-2xl font-bold mb-3">–í–∞—à –∑–∞–ª –ø–æ–∫–∞ –ø—É—Å—Ç</h2>
          <p className="mb-8 text-base" style={{ color: 'var(--color-text-secondary)' }}>
            –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É. –°–æ–∑–¥–∞–π—Ç–µ –±–∞–∑—É –ø–æ–¥–æ–ø–µ—á–Ω—ã—Ö –∏ –Ω–∞—á–Ω–∏—Ç–µ —Å–æ—Å—Ç–∞–≤–ª—è—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø–ª–∞–Ω—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫!
          </p>
          <Button onClick={handleAddClient} className="w-full">
            ‚ûï –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
          </Button>
        </div>
      </div>
    );
  }

  return (
    <div className="max-w-7xl mx-auto p-6 safe-area-bottom">
      {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */}
      <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-8 gap-4 animate-fade-in">
        <div>
          <h1 className="text-4xl font-bold mb-2">
            –î–∞—à–±–æ—Ä–¥ —Ç—Ä–µ–Ω–µ—Ä–∞
          </h1>
          <p className="text-sm" style={{ color: 'var(--color-text-secondary)' }}>
            –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞–º–∏
          </p>
        </div>
        <div className="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
          <Button
            onClick={() => setShowAIAnalysis(!showAIAnalysis)}
            className="w-full sm:w-auto"
            style={{
              background: showAIAnalysis
                ? 'linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)'
                : undefined,
              border: showAIAnalysis ? '1px solid rgba(99, 102, 241, 0.5)' : undefined,
            }}
          >
            ‚ú® –ê–Ω–∞–ª–∏–∑ –∫–ª–∏–µ–Ω—Ç–æ–≤ –ò–ò
          </Button>
          <Button onClick={() => setShowTelegramAdd(true)} className="w-full sm:w-auto">
            üì± –î–æ–±–∞–≤–∏—Ç—å –∏–∑ Telegram
          </Button>
          <Button onClick={handleAddClient} className="w-full sm:w-auto">
            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
          </Button>
        </div>
      </div>

      {/* –ò–ò-–∞–Ω–∞–ª–∏–∑ –∫–ª–∏–µ–Ω—Ç–æ–≤ */}
      {showAIAnalysis && (
        <div
          className="mb-8 p-6 rounded-2xl animate-fade-in"
          style={{
            background: 'linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%)',
            border: '1px solid rgba(99, 102, 241, 0.3)',
          }}
        >
          <div className="flex items-start gap-3 mb-4">
            <span className="text-3xl">‚ú®</span>
            <div className="flex-1">
              <h3 className="font-bold text-lg mb-2" style={{ color: '#a78bfa' }}>
                –ê–Ω–∞–ª–∏–∑ –∫–ª–∏–µ–Ω—Ç–æ–≤ –æ—Ç –ò–ò
              </h3>
              <AIClientsAnalysis clients={clients} />
            </div>
            <button
              onClick={() => setShowAIAnalysis(false)}
              className="p-1 rounded-lg hover:bg-white/10 transition-colors"
              aria-label="–ó–∞–∫—Ä—ã—Ç—å –∞–Ω–∞–ª–∏–∑"
            >
              ‚úï
            </button>
          </div>
        </div>
      )}

      {/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç—Ä–µ–Ω–µ—Ä–∞ */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
        {/* –í—Å–µ–≥–æ –ø–æ–¥–æ–ø–µ—á–Ω—ã—Ö */}
        <div 
          className="card animate-fade-in"
          style={{ 
            animationDelay: '0.1s',
            background: 'linear-gradient(135deg, rgba(24, 24, 27, 0.9) 0%, rgba(255, 82, 82, 0.1) 100%)',
            border: '1px solid rgba(255, 82, 82, 0.2)',
          }}
        >
          <div className="flex items-center gap-4">
            <div 
              className="text-4xl p-3 rounded-xl"
              style={{
                backgroundColor: 'rgba(255, 82, 82, 0.2)',
                color: '#FF5252',
              }}
            >
              üë•
            </div>
            <div>
              <p className="text-sm mb-1" style={{ color: 'var(--color-text-secondary)' }}>
                –í—Å–µ–≥–æ –ø–æ–¥–æ–ø–µ—á–Ω—ã—Ö
              </p>
              <p className="text-3xl font-bold" style={{ color: '#FF5252' }}>
                {stats.totalClients}
              </p>
            </div>
          </div>
        </div>

        {/* –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∑–∞ –Ω–µ–¥–µ–ª—é */}
        <div 
          className="card animate-fade-in"
          style={{ 
            animationDelay: '0.2s',
            background: 'linear-gradient(135deg, rgba(24, 24, 27, 0.9) 0%, rgba(255, 82, 82, 0.1) 100%)',
            border: '1px solid rgba(255, 82, 82, 0.2)',
          }}
        >
          <div className="flex items-center gap-4">
            <div 
              className="text-4xl p-3 rounded-xl"
              style={{
                backgroundColor: 'rgba(255, 82, 82, 0.2)',
                color: '#FF5252',
              }}
            >
              üí™
            </div>
            <div>
              <p className="text-sm mb-1" style={{ color: 'var(--color-text-secondary)' }}>
                –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∑–∞ –Ω–µ–¥–µ–ª—é
              </p>
              <p className="text-3xl font-bold" style={{ color: '#FF5252' }}>
                {stats.workoutsLastWeek}
              </p>
            </div>
          </div>
        </div>

        {/* % –£—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏ */}
        <div 
          className="card animate-fade-in"
          style={{ 
            animationDelay: '0.3s',
            background: 'linear-gradient(135deg, rgba(24, 24, 27, 0.9) 0%, rgba(255, 82, 82, 0.1) 100%)',
            border: '1px solid rgba(255, 82, 82, 0.2)',
          }}
        >
          <div className="flex items-center gap-4">
            <div 
              className="text-4xl p-3 rounded-xl"
              style={{
                backgroundColor: 'rgba(255, 82, 82, 0.2)',
                color: '#FF5252',
              }}
            >
              üìä
            </div>
            <div>
              <p className="text-sm mb-1" style={{ color: 'var(--color-text-secondary)' }}>
                –£—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å
              </p>
              <p className="text-3xl font-bold" style={{ color: '#FF5252' }}>
                {stats.completionRate}%
              </p>
            </div>
          </div>
        </div>
      </div>

      {/* –°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ */}
      <div>
        <h2 className="text-2xl font-bold mb-4">–ú–æ–∏ –∫–ª–∏–µ–Ω—Ç—ã</h2>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {clients.map((client: Client, index: number) => (
            <ClientCard
              key={client.id}
              client={client}
              index={index}
              getGoalLabel={getGoalLabel}
              getEquipmentLabel={getEquipmentLabel}
              getClientStatus={getClientStatus}
            />
          ))}
        </div>
      </div>

      {/* Floating Action Button –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */}
      <button
        onClick={handleAddClient}
        className="fixed bottom-24 right-6 md:hidden z-40 w-14 h-14 rounded-full btn-primary flex items-center justify-center text-2xl shadow-xl animate-scale-in"
        style={{
          boxShadow: '0 8px 16px -4px rgba(255, 68, 68, 0.4), 0 4px 8px -2px rgba(255, 68, 68, 0.3)',
        }}
        aria-label="–î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞"
      >
        ‚ûï
      </button>
    </div>
  );
}

/**
 * –ö–∞—Ä—Ç–æ—á–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞
 */
interface ClientCardProps {
  client: Client;
  index: number;
  getGoalLabel: (goal: ClientGoal) => string;
  getEquipmentLabel: (equipment: Equipment) => string;
  getClientStatus: (client: Client) => { label: string; color: string; bg: string };
}

function ClientCard({ client, index, getGoalLabel, getEquipmentLabel, getClientStatus }: ClientCardProps) {
  const navigate = useNavigate();
  const selectClient = useAppStore((state) => state.selectClient);
  const deleteClient = useAppStore((state) => state.deleteClient);
  const addToast = useAppStore((state) => state.addToast);

  const handleCardClick = () => {
    selectClient(client.id);
    navigate(ROUTES.TRAINER.CLIENT_PROFILE(client.id));
  };

  const handleAssignPlan = (e: React.MouseEvent) => {
    e.stopPropagation();
    navigate(ROUTES.TRAINER.ASSIGN_WORKOUT(client.id));
  };

  const handleViewDetails = (e: React.MouseEvent) => {
    e.stopPropagation();
    selectClient(client.id);
    navigate(ROUTES.TRAINER.CLIENT_PROFILE(client.id));
  };

  const handleDelete = (e: React.MouseEvent) => {
    e.stopPropagation();
    if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ "${client.name}"?`)) {
      deleteClient(client.id);
      addToast({
        type: 'success',
        message: `–ö–ª–∏–µ–Ω—Ç "${client.name}" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω`,
      });
    }
  };

  const status = getClientStatus(client);
  
  // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –≤ –∏—Å—Ç–æ—Ä–∏–∏
  const historyCount = client.workoutHistory?.length || client.completedWorkouts?.length || 0;

  return (
    <motion.div
      className="card-hover relative"
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ delay: index * 0.1 }}
      whileHover={{ scale: 1.02 }}
      whileTap={{ scale: 0.98 }}
    >
      <div className="space-y-4">
        {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∏–º–µ–Ω–µ–º –∏ –∫–Ω–æ–ø–∫–æ–π —É–¥–∞–ª–µ–Ω–∏—è */}
        <div className="flex items-start justify-between">
          <div 
            className="flex-1 cursor-pointer"
            onClick={handleCardClick}
          >
            <div className="flex items-center gap-2 mb-2">
              <h3 className="text-xl font-bold">{client.name}</h3>
              {/* –ò–∫–æ–Ω–∫–∞ Telegram */}
              <div
                title={client.isTelegramLinked || client.telegramId ? 'Telegram –ø—Ä–∏–≤—è–∑–∞–Ω' : 'Telegram –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω'}
                style={{
                  opacity: client.isTelegramLinked || client.telegramId ? 1 : 0.3,
                  filter: client.isTelegramLinked || client.telegramId ? 'none' : 'grayscale(100%)',
                }}
              >
                <TelegramIcon 
                  size={20} 
                  color={client.isTelegramLinked || client.telegramId ? '#26A5E4' : '#666'} 
                />
              </div>
            </div>
            {client.age && (
              <p className="text-sm" style={{ color: 'var(--color-text-secondary)' }}>
                {client.age} –ª–µ—Ç
              </p>
            )}
          </div>
          <div className="flex items-center gap-2">
            <span
              className="badge-primary text-xs px-2 py-1 rounded-full font-medium"
              style={{
                backgroundColor: status.bg,
                color: status.color,
                border: `1px solid ${status.color}33`,
              }}
            >
              {status.label}
            </span>
            <button
              onClick={handleDelete}
              className="p-2 rounded-lg hover:bg-[var(--color-card-hover)] transition-colors"
              aria-label="–£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞"
              style={{ color: 'var(--color-error)' }}
            >
              üóëÔ∏è
            </button>
          </div>
        </div>

        {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ */}
        <div className="space-y-2" onClick={handleCardClick} style={{ cursor: 'pointer' }}>
          <div className="flex items-center justify-between text-sm">
            <span style={{ color: 'var(--color-text-secondary)' }}>–¶–µ–ª—å:</span>
            <span className="font-medium">{getGoalLabel(client.goal)}</span>
          </div>
          <div className="flex items-center justify-between text-sm">
            <span style={{ color: 'var(--color-text-secondary)' }}>–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ:</span>
            <span className="font-medium">{getEquipmentLabel(client.equipment)}</span>
          </div>
        </div>

        {/* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å */}
        <div className="divider" />

        {/* –°—Ç–∞—Ç—É—Å –∏ –∫–Ω–æ–ø–∫–∏ */}
        <div className="flex gap-2">
          <Button
            onClick={handleAssignPlan}
            variant="primary"
            className="flex-1"
          >
            {client.weeklyPlan && Object.values(client.weeklyPlan).some(day => day && day.length > 0)
              ? '‚úèÔ∏è –ü–ª–∞–Ω'
              : '‚ûï –ü–ª–∞–Ω'}
          </Button>
          
          {/* –ö–Ω–æ–ø–∫–∞ –ü–æ–¥—Ä–æ–±–Ω–µ–µ */}
          <Button
            onClick={handleViewDetails}
            variant="secondary"
            className="flex-1"
          >
            <span className="flex items-center justify-center gap-1">
              <span>üìã</span>
              <span>–ü–æ–¥—Ä–æ–±–Ω–µ–µ</span>
              {historyCount > 0 && (
                <span
                  className="px-1.5 py-0.5 rounded-full text-xs font-bold ml-1"
                  style={{
                    backgroundColor: 'rgba(255, 82, 82, 0.2)',
                    color: 'var(--color-accent)',
                  }}
                >
                  {historyCount}
                </span>
              )}
            </span>
          </Button>
        </div>
      </div>
    </motion.div>

  return (
    <>
      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–∑ Telegram */}
      {showTelegramAdd && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <motion.div
            initial={{ opacity: 0, scale: 0.9 }}
            animate={{ opacity: 1, scale: 1 }}
            exit={{ opacity: 0, scale: 0.9 }}
            className="max-w-md w-full"
          >
            <div
              className="p-6 rounded-2xl"
              style={{
                backgroundColor: 'var(--color-background)',
                border: '1px solid var(--color-border)',
              }}
            >
              <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
                <span>üì±</span>
                –î–æ–±–∞–≤–∏—Ç—å –∏–∑ Telegram
              </h3>
              
              <p className="text-sm mb-4" style={{ color: 'var(--color-text-secondary)' }}>
                –í–≤–µ–¥–∏—Ç–µ username –∫–ª–∏–µ–Ω—Ç–∞ –≤ Telegram (–±–µ–∑ @). –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏—Ç –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤ —Å–µ—Ä–≤–∏—Å.
              </p>

              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium mb-2">
                    Telegram Username
                  </label>
                  <input
                    type="text"
                    value={telegramUsername}
                    onChange={(e) => setTelegramUsername(e.target.value.replace('@', ''))}
                    placeholder="username"
                    className="w-full px-4 py-3 rounded-lg border focus:outline-none focus:ring-2"
                    style={{
                      backgroundColor: 'var(--color-background-secondary)',
                      borderColor: 'var(--color-border)',
                      color: 'var(--color-text)',
                    }}
                  />
                </div>

                <div className="flex gap-3">
                  <Button
                    onClick={() => {
                      setShowTelegramAdd(false);
                      setTelegramUsername('');
                    }}
                    variant="secondary"
                    className="flex-1"
                  >
                    –û—Ç–º–µ–Ω–∞
                  </Button>
                  <Button
                    onClick={handleTelegramAdd}
                    className="flex-1"
                    disabled={!telegramUsername.trim()}
                  >
                    üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
                  </Button>
                </div>
              </div>
            </div>
          </motion.div>
        </div>
      )}
    </>
  );
}
